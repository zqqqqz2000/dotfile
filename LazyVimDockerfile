FROM debian:bookworm

RUN rm -r /etc/apt/sources.list.d
COPY <<EOT /etc/apt/sources.list
deb http://mirrors.tuna.tsinghua.edu.cn/debian/ bookworm main contrib non-free non-free-firmware
deb-src http://mirrors.tuna.tsinghua.edu.cn/debian/ bookworm main contrib non-free non-free-firmware

deb http://mirrors.tuna.tsinghua.edu.cn/debian/ bookworm-updates main contrib non-free non-free-firmware
deb-src http://mirrors.tuna.tsinghua.edu.cn/debian/ bookworm-updates main contrib non-free non-free-firmware

deb http://mirrors.tuna.tsinghua.edu.cn/debian/ bookworm-backports main contrib non-free non-free-firmware
deb-src http://mirrors.tuna.tsinghua.edu.cn/debian/ bookworm-backports main contrib non-free non-free-firmware

deb http://mirrors.tuna.tsinghua.edu.cn/debian-security bookworm-security main contrib non-free non-free-firmware
deb-src http://mirrors.tuna.tsinghua.edu.cn/debian-security bookworm-security main contrib non-free non-free-firmware
EOT

RUN apt-get update -y && apt-get install -y sudo curl zsh git gcc

# lazygit
RUN LAZYGIT_VERSION=$(curl -s "https://api.github.com/repos/jesseduffield/lazygit/releases/latest" | grep -Po '"tag_name": "v\K[^"]*') && \
  curl -Lo lazygit.tar.gz "https://github.com/jesseduffield/lazygit/releases/latest/download/lazygit_${LAZYGIT_VERSION}_Linux_x86_64.tar.gz" && \
  tar xf lazygit.tar.gz lazygit && \
  install lazygit /usr/local/bin

RUN curl -LO https://github.com/neovim/neovim/releases/latest/download/nvim-linux64.tar.gz && \
  rm -rf /opt/nvim && \
  tar -C /opt -xzf nvim-linux64.tar.gz && \
  rm nvim-linux64.tar.gz

ENV PATH="$PATH:/opt/nvim-linux64/bin"

# add user
RUN useradd -ms /usr/bin/zsh dev && \
  usermod -aG sudo dev && \
  echo "dev ALL=(ALL) NOPASSWD: ALL" > /etc/sudoers && \
  chsh -s $(which zsh)

USER dev

RUN sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)"

# config zsh tmux
ADD --chown=dev .zshrc .tmux.conf

# config nvim
COPY --chown=dev .config /home/dev/.config
# sync multiple times
RUN nvim --headless -c 'lua require("lazy").install({ wait = true, show = false, concurrency = 20 })' +qa && \
  nvim --headless -c 'lua require("lazy").update({ wait = true, show = false, concurrency = 20 })' +qa && \
  nvim --headless -c 'lua require("lazy").update({ wait = true, show = false, concurrency = 20 })' +qa && \
  nvim --headless -c 'lua require("lazy").update({ wait = true, show = false, concurrency = 20 })' +qa && \
  nvim --headless -c 'lua require("lazy").update({ wait = true, show = false, concurrency = 20 })' +qa && \
  nvim --headless -c 'MasonInstallAll' +qa

WORKDIR /home/dev
ENTRYPOINT ["nvim"]
